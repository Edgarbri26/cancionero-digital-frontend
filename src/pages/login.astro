---
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";

import { login } from "../services/auth";

let errorMessage = "";

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const email = data.get("email");
        const password = data.get("password");

        const response = await login(email, password);

        if (response && response.ok) {
            // Forward cookies from backend to client
            const setCookie = response.headers.get("set-cookie");

            if (setCookie) {
                // Extract token from cookie string (assuming format "token=...; ...")
                const match = setCookie.match(/token=([^;]+)/);
                const token = match ? match[1] : null;

                if (token) {
                    Astro.cookies.set("token", token, {
                        path: "/",
                        httpOnly: true,
                        secure: import.meta.env.PROD,
                        sameSite: "lax",
                    });
                    return Astro.redirect("/");
                }
            } else {
                // Fallback: try to see if token is in body
                const body = await response.json();
                if (body.token) {
                    Astro.cookies.set("token", body.token, {
                        path: "/",
                        httpOnly: true,
                        secure: import.meta.env.PROD,
                        sameSite: "lax",
                    });
                    return Astro.redirect("/");
                }
            }
            errorMessage = "Error: No se recibió el token de autenticación.";
        } else {
            errorMessage = "Credenciales incorrectas.";
        }
    } catch (error) {
        console.error(error);
        errorMessage = "Error de conexión.";
    }
}
---

<Layout title="Iniciar Sesión - Cancionero">
    <div
        class="flex flex-col min-h-screen bg-bg-main text-text-main items-center justify-center p-4"
    >
        <div
            class="w-full max-w-md bg-bg-secondary p-8 rounded-xl shadow-lg border border-white/5"
        >
            <h1 class="text-2xl font-bold text-accent-main mb-6 text-center">
                Iniciar Sesión
            </h1>

            <form id="loginForm" method="POST" class="space-y-6">
                <div>
                    <label
                        for="email"
                        class="block text-sm font-medium text-text-secondary mb-2"
                        >Correo Electrónico</label
                    >
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        class="w-full bg-bg-main border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-main transition-colors"
                        placeholder="admin@example.com"
                    />
                </div>

                <div>
                    <label
                        for="password"
                        class="block text-sm font-medium text-text-secondary mb-2"
                        >Contraseña</label
                    >
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        class="w-full bg-bg-main border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent-main transition-colors"
                        placeholder="••••••••"
                    />
                </div>

                <button
                    id="submitBtn"
                    type="submit"
                    class="w-full bg-accent-main text-white font-bold py-3 rounded-lg hover:bg-accent-secondary transition-transform transform active:scale-95 flex justify-center items-center gap-2"
                >
                    <span>Ingresar</span>
                </button>
            </form>
        </div>
    </div>
</Layout>

<script define:vars={{ errorMessage }}>
    import Swal from "sweetalert2";

    // Manejo de errores recibidos del servidor
    if (errorMessage) {
        Swal.fire({
            icon: "error",
            title: "Error de acceso",
            text: errorMessage,
            background: "#1f2937",
            color: "#fff",
            confirmButtonColor: "#f97316",
        });
    }

    const form = document.getElementById("loginForm");
    const btn = document.getElementById("submitBtn");

    form?.addEventListener("submit", () => {
        if (btn) {
            btn.setAttribute("disabled", "true");
            btn.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Ingresando...</span>
            `;
            btn.classList.add("opacity-75", "cursor-not-allowed");
        }
    });
</script>
